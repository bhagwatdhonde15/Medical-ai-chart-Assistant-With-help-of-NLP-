import customtkinter as ctk
import speech_recognition as sr
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.metrics.pairwise import cosine_similarity
from gtts import gTTS
import os
import pygame
import threading
import time
import random
import csv
import openai


# ================= OPENAI API KEY =================

openai.api_key = "....."
# ================================================


# ================= TKINTER SETUP =================
ctk.set_appearance_mode("System")
ctk.set_default_color_theme("blue")


# ================= LOAD CSV DATA =================
BASE_DIR = os.path.dirname(os.path.abspath(__file__))
CSV_FILE = os.path.join(BASE_DIR, "sanjivani_university_data.csv")

university_data = {}

try:
    with open(CSV_FILE, mode="r", encoding="utf-8") as file:
        reader = csv.DictReader(file)
        for row in reader:
            if row.get("question") and row.get("answer"):
                university_data[row["question"].lower().strip()] = row["answer"]

    print("CSV loaded successfully!")
    print("Total questions loaded:", len(university_data))
    questions = list(university_data.keys())

except FileNotFoundError:
    print("CSV file not found. Keep it in same folder.")
    exit()



with open("sanjivani_university_data.csv", mode='r') as file:
    university_data = csv.DictReader(file)
 #= {csv_reader}

try:
    with open(CSV_FILE, encoding="utf-8") as file:
        reader = csv.DictReader(file)
        for row in reader:
            if row["question"] and row["answer"]:
                university_data[row["question"].lower()] = row["answer"]
except FileNotFoundError:
    print("CSV file not found. Please keep CSV in same folder.")

questions = list(university_data.keys())
print("Questions loaded:", len(questions))


# ================= MAIN APP =================
class SanjivaniAssistant(ctk.CTk):

    def __init__(self):
        super().__init__()

        self.title("Sanjivani University AI Assistant")
        self.geometry("1000x650")
        self.resizable(False, False)

        pygame.mixer.init()
        self.recognizer = sr.Recognizer()
        self.is_listening = False

        self.grid_columnconfigure(1, weight=1)
        self.grid_rowconfigure(0, weight=1)

        self.create_sidebar()

        self.chat_frame = ctk.CTkScrollableFrame(self, fg_color="transparent")
        self.chat_frame.grid(row=0, column=1, padx=20, pady=(20, 0), sticky="nsew")

        self.create_input_area()

        self.after(500, lambda: self.bot_response(
            "Hello! I am Sanjivani University AI Assistant ðŸŽ“"
        ))

    # ========== UI ==========
    def create_sidebar(self):
        frame = ctk.CTkFrame(self, width=220, corner_radius=0)
        frame.grid(row=0, column=0, rowspan=2, sticky="nsew")

        ctk.CTkLabel(
            frame,
            text="SANJIVANI\nUNIVERSITY",
            font=ctk.CTkFont(size=22, weight="bold")
        ).pack(pady=30)

    def create_input_area(self):
        frame = ctk.CTkFrame(self, height=80)
        frame.grid(row=1, column=1, padx=20, pady=20, sticky="ew")
        frame.grid_columnconfigure(0, weight=1)

        self.entry_box = ctk.CTkEntry(
            frame, placeholder_text="Type your message...", height=45
        )
        self.entry_box.grid(row=0, column=0, padx=10, pady=10, sticky="ew")
        self.entry_box.bind("<Return>", self.send_text)

        ctk.CTkButton(frame, text="âž¤", width=50,
                      command=self.send_text).grid(row=0, column=1, padx=5)

        ctk.CTkButton(frame, text="ðŸŽ¤", width=50,
                      command=self.toggle_voice).grid(row=0, column=2, padx=5)

    # ========== CHAT ==========
    def add_message(self, sender, text):
        align = "w" if sender == "Bot" else "e"
        bubble = ctk.CTkLabel(
            self.chat_frame,
            text=text,
            corner_radius=15,
            padx=15,
            pady=10,
            wraplength=450
        )
        bubble.pack(anchor=align, pady=5)
        self.chat_frame._parent_canvas.yview_moveto(1.0)

    def send_text(self, event=None):
        text = self.entry_box.get()
        if text.strip():
            self.entry_box.delete(0, "end")
            self.add_message("You", text)
            self.process_query(text)

    # ========== QUERY HANDLER ==========
    def process_query(self, query):
        query = query.lower()

        if "time" in query:
            response = f"Current time is {time.strftime('%I:%M %p')}"

        elif "date" in query:
            response = f"Today's date is {time.strftime('%d %B %Y')}"

        else:
            response = self.get_best_match(query)

            if response.startswith("Sorry"):
                threading.Thread(
                    target=lambda: self.bot_response(self.ai_response(query)),
                    daemon=True
                ).start()
                return

        self.bot_response(response)

    # ========== TF-IDF MATCH ==========
    def get_best_match(self, user_input):

      if not questions:
        return "University dataset is empty. Please check CSV file."

      # Combine stored questions + user input
      corpus = questions + [user_input]

      vectorizer = TfidfVectorizer()
      vectors = vectorizer.fit_transform(corpus)

      user_vector = vectors[-1]
      question_vectors = vectors[:-1]

      similarity = cosine_similarity(user_vector, question_vectors)[0]

      best_index = similarity.argmax()
      best_score = similarity[best_index]

      # Threshold to avoid wrong answers
      if best_score < 0.25:
          return "Sorry, I don't have exact university data for that."

      matched_question = questions[best_index]
      return university_data[matched_question]
      def get_best_match(self, user_input): 

        if not questions:
            return "University dataset is empty. Please check CSV file."

        temp = questions + [user_input]
        vectorizer = TfidfVectorizer()
        vectors = vectorizer.fit_transform(temp)

        user_vec = vectors[-1]
        question_vecs = vectors[:-1]

        if question_vecs.shape[0] == 0:
            return "University dataset is empty."

        similarity = cosine_similarity(user_vec, question_vecs)

        best = similarity.argsort()[0][-1]
        score = similarity[0][best]

        if score < 0.2:
            return "Sorry, I don't have exact university data for that."

        return university_data[questions[best]]

    # ========== OPENAI ==========
    def ai_response(self, query):
        try:
            res = openai.ChatCompletion.create(
                model="gpt-3.5-turbo",
                messages=[
                    {"role": "system", "content": "You are a university help desk assistant."},
                    {"role": "user", "content": query}
                ],
                max_tokens=150
            )
            return res["choices"][0]["message"]["content"]
        except:
            return "AI service is currently unavailable."

    # ========== BOT OUTPUT ==========
    def bot_response(self, text):
        self.add_message("Bot", text)
        threading.Thread(
            target=self.speak_text,
            args=(text,),
            daemon=True
        ).start()

    def speak_text(self, text):
        try:
            filename = f"voice_{random.randint(1000,9999)}.mp3"
            gTTS(text=text, lang="en").save(filename)
            pygame.mixer.music.load(filename)
            pygame.mixer.music.play()
            while pygame.mixer.music.get_busy():
                pygame.time.Clock().tick(10)
            pygame.mixer.music.unload()
            os.remove(filename)
        except:
            pass

    # ========== VOICE ==========
    def toggle_voice(self):
        threading.Thread(target=self.listen, daemon=True).start()

    def listen(self):
        with sr.Microphone() as src:
            audio = self.recognizer.listen(src)
            try:
                text = self.recognizer.recognize_google(audio)
                self.add_message("You", text)
                self.process_query(text)
            except:
                self.add_message("Bot", "Sorry, I couldn't hear you.")


# ================= RUN =================
if __name__ == "__main__":
    app = SanjivaniAssistant()
    app.mainloop()
